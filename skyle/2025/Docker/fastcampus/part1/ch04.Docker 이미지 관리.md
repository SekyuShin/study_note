ch04.Docker 이미지 관리
Created at : 2025-02-23 21:41

# Clip1 docker image 이해와 구조 확인

### docker 컨테이너 서비스를 위한 image
- docker image는 Container runtime에 필요한 바이너리, 라이브러리 및 설정 값 등을 포함하고, 변경되는 상태 값을 <span style="background:#d3f8b6">보유하지 않고(stateless) 변하지 않는다. (Immutable, RO)</span>
- 일반적인 컨테이너 애플리케이션 서비스 개발 과정 이해를 통해 image에 대해 이해해 보자.
- ![[Pasted image 20250223215701.png]]

### docker image 관련 명령어 workflow
- ![[Pasted image 20250223215752.png]]
- ![[Pasted image 20250223215741.png]]

### 이미지 내려받기
- Docker는 hub.docker.com(docker.io)으로 부터 이미지를 제공 받거나 제공한다.
- 또는, 기업의 인프라에 개별적인 Private registry 서버를 두고, 이곳에 이미지를 pull/push 하기도 한다.
```
docker [image] pull [options] name:[tag]
```
- 기본적으로 docker.io가 default registry로 등록되어 있다.
```
docker pull debian[:latest] ~$ docker pull library/debian:10
docker pull docker.io/library/debian:10
docker pull index/docker.io/library/debian:10
```
- 만일, private registry 나 클라우드의 저장소(ECR, GCR 등)의 이미지를 받는다면
```
docker pull 192.168.56.101:5000/debian:10
docker pull gcr.io/google-samples/hello-app:1.0
```
### 이미지 구조 확인
- docker image inspect: 생성된 image의 내부 구조 정보를 JSON 형태로 제공
```
docker image inspect httpd:2.4
```
```
# 주요 정보
imageID:"Id"
생성일: "Created"
Docker: "DockerVersion"
CPU 아키텍쳐 : "Architecture"
이미지 다이제스트 정보 : "RootFS"
이미지 레이어 저장 정보: "GraphDriver"
```
```
docker image inspect --format="{{.Os}}" httpd:2.4
docker image inspect --format="{{.RepoTags}}" httpd:2.4
docker image inspect --format="{{.ContainerConfig.ExposedPorts}}" httpd:2.4
docker image inspect --format="{{.RepoTags}} {{.Os}}" httpd:2.4
```
- docker history: docker image는 Dockerfile을 통해 build 됨. history는 이 정보를 제공.
```
docker image history httpd:2.4
```
![[Pasted image 20250223220435.png]]
- 이미지를 내려 받는 과정에서는 아래와 같이 이미지가 계층(Layer) 구조라는 것을 보여준다.
```
docker pull httpd:2.4
```
![[Pasted image 20250223220530.png]]
![[Pasted image 20250223220544.png]]
- download된 layer들은 distribution ID를 부여 받고 docker 전용 경로에 저장된다.
```
sudo su –
cd /var/lib/docker/image/overlay2/distribution/diffid-by-digest/sha256/
```
![[Pasted image 20250223220712.png]]
- 아래 그림과 같은 형태로 이미지는 불변 즉, read only 형태로 만들어지고
- docker run 명령으로 컨테이너를 생성하면 [Container layer]가 read write로 추가된다.
- 하나의 이미지는 원하는 만큼의 컨테이너를 생성할 수 있다.
![[Pasted image 20250223220845.png]]
	- 여러 개의 layer를 하나의 FS으로 사용하게 해주는 기능을 UFS(union filesystem)이라 함.

# Clip2 docker hub repositories에 image push
### 이미지 올리기 (push)
- Dockerfile을 통해 생성된 이미지나 docker commit을 통해 생성된 이미지를 저장하는 곳을registry라고 한다.
- Registry는 공개적으로 사용하는 Public registry와 회사 내부에서만 접근되도록 하는Private registry가 있다.
- 여기서는 Docker에서 hub.docker.com을 이용해 docker push를 수행해 본다.
- ![[Pasted image 20250223221111.png]]
### docker login/logout
- hub.docker.com에 회원가입 후 서버에서 docker login을 통해 본인 저장소에 업로드 한다.
- Docker는 3가지 접근 방법을 제공, 2가지 방법을 확인해 본다.
	- 암호로 접근
		- `docker login`
		- `docker info | grep Username`
		- <span style="background:#d3f8b6">입력한 암호는 암호화 되지 않는다. 제공되는 경로를 열어보면 base64 인코딩 값이다.</span>
			- <font color="#00b050">지금은 웹사이트에서 인증하는 방식으로 바뀐듯</font>
			- 인코딩 : `echo 'welcome fastcampus' | base64`
			- 디코딩 : `echo d2VsY29tZSBmYXN0Y2FtcHVzCg== | base64 -d`
	- Tocker으로 접근
		- `vi .access_token`
			- token 입력
		- `cat .access_token | docker login --username 본인 계정 --password-stdin`
		- `docker info | grep Username`
### docker [image] tag
- hub.docker.com에 <span style="background:#d3f8b6">본인 계정</span>의 Repositories에 생성한 이미지를 업로드하기 위해서는<span style="background:#d3f8b6"> 본인계정을 이미지 명 앞에</span> 붙여야 docker push 수행 시 계정으로 찾아가 저장된다.
```
docker images
```
![[Pasted image 20250223221800.png]]
```
docker image tag myweb:v1.0 skylesin/myweb:v1.0
docker images
```
![[Pasted image 20250223221816.png]]
```
docker push dbgurum/myweb:v1.0
```
- hub.docker.com에 push된 이미지를 다른 위치에서 pull 해보고, docker run 으로 정상 이미지인지 확인해 본다.
- 이미지를 공유하는 방법은..
	- registry에 push하여 공유
	- 이미지를 생성하는 Dockerfile과 소스를 Github에 올려 공유
	- 이미지를 docker save를 통해 파일로 백업하여 전달 후 docker load를 통해 공유
- <font color="#00b050">Tag를 하면 Image의 ID는 동일하다. (only tagging)</font>
### docker image 백업 및 이전
- docker<span style="background:#d3f8b6"> save 명령을 통해 Layer로 구성된 이미지를 *.tar 파일로 묶어 파일</span>로 저장
- 해당 파일을 전달 받은 컴퓨터에서 docker load를 통해 이미지로 등록한다.
```
mkdir save_lab && cd $_
docker image save phpserver:1.0 > phpserver1.tar
ls -lh
```
```
-rw-rw-r-- 1 kevin kevin 331M 06월 15 11:49 phpserver1.tar
```
```
docker image save phpserver:1.0 | gzip > phpserver1.tar.gz
ls -lh
```
```
-rw-rw-r-- 1 kevin kevin 331M 06월 15 11:49 phpserver1.tar 
-rw-rw-r-- 1 kevin kevin 102M 06월 15 11:50 phpserver1.tar.gz
```
```
docker image save phpserver:1.0 | bzip2 > phpserver1.tar.bz2
ls -lh
```
```
-rw-rw-r-- 1 kevin kevin 331M 06월 15 11:49 phpserver1.tar 
-rw-rw-r-- 1 kevin kevin 102M 06월 15 11:50 phpserver1.tar.gz 
-rw-rw-r-- 1 kevin kevin 93M 06월 15 11:51 phpserver1.tar.bz2
```
```
scp phpserver1.tar.gz kevin@hostos2:/home/kevin/backup/phpserver1.tar.gz
```
```
hostos2:~/backup$ docker image load < phpserver1.tar.gz 
Loaded image: phpserver:1.0
```
```
hostos2:~/backup$ docker images 
hostos2:~/backup$ docker run -itd -p 8200:80 phpserver:1.0
hostos2:~/backup$ curl localhost:8200
```
### docker image 삭제
- Docker Hub를 통해 다운 로드(pull) 받은 이미지는 종류에 따라 용량이 다르다. 작게는 몇 MB부터 크게는 몇 GB가 넘는 것도 있다.
- 이미지를 계속 다운로드만 받게 되면 로컬 서버의 저장 용량을 많이 차지하여 공간 부족과 같은 문제를 야기하기도 한다.
- 이런 문제를 해결하기 위해 앞서 배운 docker image save를 통해 이미지를 백업하거나 주기적으로 업무에 사용하는 이미지와 사용하지 않는 이미지를 구분하여 관리하고, 불필요한 이미지는 삭제하는 것이 좋다.
```
docker image rm [옵션] {이미지명[:태그] | 이미지ID} 
docker rmi [옵션] {이미지명[:태그] | 이미지ID}
```
```
# 이미지 전체 삭제
docker rmi $(docker images –q)

# 특정 이미지명이 포함된 것만 삭제.
docker rmi $(docker images | grep debian)

# 반대로 특정 이미지명이 포함된 것만 제외하고 모두 삭제. (-v 옵션)
docker rmi $(docker images | grep -v centos)

# 자주 사용하는 명령등을 전역 alias로 적용하여 활용하면 편리하다.
vi .bashrc

# 상태가 exited 인 container를 찾아서 모두 삭제
alias cexrm='docker rm $(docker ps --filter 'status=exited' -a -q)'

# 설정한 alias를 적용하고 확인
source .bashrc 또는 . .bashrc
alias 
alias cexrm='docker rm $(docker ps --filter 'status=exited' -a -q)'
```
- <font color="#00b050">linux 명령어 중, `$(command)`이면, 명령어를 호출 한 결과물을 출력해준다.</font>
- 현재 centos:7 이미지를 사용 중인 컨테이너가 있다.
```
docker ps -a

CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
0b5612583dfa centos:7 "bash" 8 minutes ago Up 8 minutes mycontainer
```
-  이미지를 삭제하면?
```
docker image rm centos:7

Error response from daemon: conflict: unable to remove repository reference "centos:7" (must foce) - container 0b5612583dfa is using its referenced image eeb6ee3f44bd
```

-  해당 컨테이너 stop 후 rm으로 컨테이너 삭제. (stop : process 제거, rm : 스냅샷 제거)
```
docker stop 0b5612583dfa 0b5612583dfa
docker rm 0b5612583dfa
```

# Clip3 docker registry 구성과 관리

### docker container registry
- 기업 내부에서 생성한 프로젝트용 이미지를 public registry에 올리는 경우는 없다.
- image에 네트워크나 OS 및 미들웨어 설정 등의 정보가 포함되어 있으므로 <span style="background:#d3f8b6">보안상</span> Docker Hub와 같이 인터넷을 통해 불특정 다수에게 공개되는 곳에는 올릴 수 없는 경우에는 "<span style="background:#d3f8b6">Private Registry"</span>를 구축한다.
- Docker registry 는 docker image를 회사 서버에서 개별적으로 구축 관리하는 서비스다.
- 회사 인프라내에 private docker registry를 구축하기 위해서는, Docker Hub에 공개되어 있는 공식 image인 "registry"를 사용한다.
- 적은 용량의 container service로 사용하기에 적합하다.
```
docker pull registry
docker images | grep registry
docker run -d \
-v /home/skyle/registry_data:/var/lib/registry \
-p 5000:5000 \
--restart=always \
--name=local-registry \
registry

docker ps | grep registry
sudo netstat -nlp | grep 5000
```
```
curl -X GET http://192.168.56.101:5000/v2/_catalog 
	{"repositories":[]}

docker image tag myweb:v1.0 192.168.56.101:5000/myweb:v1.0
docker push 192.168.56.101:5000/myweb:v1.0
	The push refers to repository [192.168.56.101:5000/myweb] Get 
	"https://192.168.56.101:5000/v2/": http: server gave HTTP response to HTTPS 
	client
	
	# error 해결 : 현재 registry는 docker.hub만 지정되어있음
	# docker 에 해당 registry 등록하는 과정이 필요
	
sudo vi /etc/init.d/docker
	...
	DOCKER_OPTS=--insecure-registry 192.168.56.101:5000
	
sudo vi /etc/docker/daemon.json 
	{ "insecure-registries": ["192.168.56.101:5000"] }
	
sudo systemctl restart docker.service
```
```
docker info
	…
	Insecure Registries:
	192.168.56.101:5000
	127.0.0.0/8
docker push 192.168.56.101:5000/myweb:v1.0
	The push refers to repository [192.168.56.101:5000/myweb] 0e09aaca8f2d: Pushed
	…
	f1417ff83b31: Pushed 
	v1.0: digest: sha256:1e2580f9199...

curl -X GET http://192.168.56.101:5000/v2/_catalog
	{"repositories":["myweb"]}

curl -X GET http://192.168.56.101:5000/v2/myweb/tags/list
	{"name":"myweb","tags":["v1.0"]}
```
# Clip4 docker registry를 이용한 image upload / download 해보기
### docker container registry 실습
- [시나리오] 현재 운용 중인 hostos1 (registry server)과 hostos2 (client)를 이용해 private push/pull을 수행해 본다.
```
curl -X GET http://192.168.56.101:5000/v2/myweb/tags/list 
	{"name":"myweb","tags":["v1.0"]} 
	
docker image tag myweb:v1.1 192.168.56.101:5000/myweb:v1.1
docker images | grep 192
	192.168.56.101:5000/myweb v1.1 533b0d9189d6 3 days ago 41.4MB 
	192.168.56.101:5000/myweb v1.0 ed199951117d 3 days ago 41.4MB

docker push 192.168.56.101:5000/myweb:v1.1
	…
	f1417ff83b31: Layer already exists v1.1: digest: sha256:c515d72b147a321c78b...


# host2 에서 조회
```
- host2 에서 조회
```
curl -X GET http://192.168.56.101:5000/v2/_catalog 
	{"repositories":["myweb"]}
	
curl -X GET http://192.168.56.101:5000/v2/myweb/tags/list 
	{"name":"myweb","tags":["v1.0","v1.1"]}
```

-  host2에서 register 등록 및 pull
```
sudo vi /etc/init.d/docker
	...
	DOCKER_OPTS=--insecure-registry 192.168.56.101:5000
	
sudo vi /etc/docker/daemon.json 
	{ "insecure-registries": ["192.168.56.101:5000"] }
	
sudo systemctl restart docker.service

docker pull 192.168.56.101:5000/myweb:v1.0
docker image tag 192.168.56.101:5000/myweb:v1.0 dev_http:1.1
docker images 
docker run -d -p 8100:80 --name myweb-server dev_http:1.1
```
- 기본 docker registry는 http 접근으로 별도의 인증 절차가 없다.
- 보안 구성을 위해 별도로 SSL(openssl)로 인증서를 만들어 보안 인증 구성도 가능하다.
- [시나리오] 샘플 이미지를 생성하여 private registry에 push/pull 해본다.
```
git clone https://github.com/hylee-kevin/fastcampus.git 
cd fastcampus/ch04 
ls 
	Dockerfile index.php index.php2 index.php3
	
cat Dockerfile 
cat index.php 
docker build -t phpserver:1.0 .
docker images | grep phpserver
	phpserver 1.0 35dbb7ccd414 3 minutes ago 410MB
	
docker run -it -d -p 8004:80 -h phpserver --name=phpserver phpserver:1.0
curl localhost:8004
```
- 이미지를 생성하면 반드시 docker run을 통해 컨테이너 실행 여부를 확인해야 한다. 
```
docker image tag phpserver:1.0 192.168.56.101:5000/phpserver:1.0
docker images | grep phpserver 
	192.168.56.101:5000/phpserver 1.0 7a70be7bd298 About a minute ago 410MB 
	phpserver 1.0 7a70be7bd298 About a minute ago 410MB
	
docker push 192.168.56.101:5000/phpserver:1.0
curl -X GET http://192.168.56.101:5000/v2/_catalog
	{"repositories":["myweb","phpserver"]}
	
curl -X GET http://192.168.56.101:5000/v2/phpserver/tags/list 
	{"name":"phpserver","tags":["1.0"]}
```
```
curl -X GET http://192.168.56.101:5000/v2/_catalog 
	{"repositories":["myweb","phpserver"]}
	
curl -X GET http://192.168.56.101:5000/v2/phpserver/tags/list 
	{"name":"phpserver","tags":["1.0"]}
	
docker pull 192.168.56.101:5000/phpserver:1.0
docker images | grep 192 
	192.168.56.101:5000/phpserver 1.0 7a70be7bd298 4 minutes ago 410MB
	
docker run -it -d -p 8004:80 -h phpserver --name=phpserver 
	192.168.56.101:5000/phpserver:1.0
docker ps | grep php
curl localhost:8004
```
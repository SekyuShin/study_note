ch02.Docker 플랫폼 구성
Created at : 2025-02-19 21:34
# Clip1 Oracle VirtualBox 설치
### 기본 Requirements
- 가상화 프로그램 사용 시 설치되는 운영체제의 가상화 기능 활성화 요구
	- 부팅 시 CMOS 설정에서 CPU 기능 중 VT-x/AMD-V/VMX 등 설정
	- ![[Pasted image 20250219214032.png]]
- 설치 시 신규 가상 네트워크 인터페이스 설정이 추가되므로 설치
	- 새로 설치되는 가상 NIC는 윈도우에서의 접속 IP or VM에 설치되는 OS의 gateway 역할 수행
	- 설치 후 확인 필요 (VirtualBox Host-Only Ethernet Adapter)
---
# Clip2 Ubuntu 22.04 설치
### Ubuntu 22.04 download (https://ubuntu.com/download/desktop)
### Setup 
-  host name : fc_hostos1
	- <font color="#00b050">C드라이브 제외하고 폴더 선택 : os disk는 충돌이 일어날 수 있기에 피하자.</font>
- memory : 최소 4G/ select 8G
- Processors : 4개
	- <font color="#00b050">Provisioning : 사용자의 요구에 맞게 시스템 자체를 제공 하는 것 (최대 얼마까지 사용하겠다)</font>
- Disk : 100G
- ID/PASSWORD : skyle/skyle123
- hostname : fchost1
- 설정
	- 시스템 - 마더보드 : 광디스크1번, 하드디스크 2번
	- 시스템 - 프로세서 - PAE/NX 체크
		- <font color="#00b050">CPU과부화 주면 컴퓨터가 Down 되는 상황 방지</font>
	- 디스플레이-화면 : 그래픽컨트롤러 
		- <font color="#00b050">비디오카드와 VM이 안맞을 때 동작 안할 수 있다.</font>
		- (default) VMSVGA -> VBoxVGA
	- 저장소 
		- 컨트롤러:IDE (image 파일)
		- 하드 - 추가
			- VDI 선택 - fc_host1_docker 생성
			- <font color="#00b050">OS와 Docker는 분리하는 것을 권장</font>
		- 네트워크
			- 어댑터 1 : NAT (외부 연결용)
			- 어댑터 2 : 호스트 전용 어댑터 (내부 연결용?)
				- <font color="#00b050">실제 호스트 네트워크 연결에 나와있음 : 192.168.56.1</font>
- 파일 - 환경설정-입력-가상머신-호스트 키 조합 (ctrl+alt)
- Install
	- partition (Something else)
		- ![[Pasted image 20250219230907.png]]
---
# Clip3 Ubuntu Linux 환경 구성
### network 환경 구성과 remote 접속 설정
- ![[Pasted image 20250221232108.png]]
	- enp0s3 : NAT
	- enp0s8 : 이더넷 설정
		- IP : 192.168.56.101
		- Netmask : 255.255.255.0
		- GateWay : 192.168.56.2 (VM gateway), 192.168.56.1 (windows gateway)
			- <font color="#00b050">But, 192.168.56.1은 client 접속 용으로 사용 예정</font>
- apt update 및 필요 도구 설치
```
		sudo apt update
		sudo apt -y install openssh-server vim net-tools
		sudo apt -y update
```

-  check network
```
		ifconfig
		ping -c 2 192.168.56.1
```
- ping : packet internet groper

# Clip4 Docker Engine 설치와 확인
### Ubuntu 22.04 기반의 최신 버전의 docker engine 설치
-  설치 고려 사항 : 리눅스 커널 정보(3.10 이상)와 64비트 확인(x86_64)
```
		uname -ar
```
![[Pasted image 20250221234343.png]]

- docker 사용에 필요한 패키지 설치
```
sudo apt-get install -y \
apt-transport-https \
ca-certificates \
curl \
gnupg-agent \
software-properties-common
```
	- apt-transport-https : https 링크로 데이터를 전달 받기 위한 apt
	- ca-certificates : 인증서 apt(https 사용을 위해)
	- gnupg-agent : pkg gaurd apt
	- software-properties-common : repository 기능이나 관리 기능 제공 apt

- Docker의 공식 GPG(GNU Privacy Guard) key를 추가
```
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
```
---
	- <font color="#00b050">Ubuntu 22.04 부터 시스템 보안 강화를 위해  apt-key를 keyring 아래에 GPG key 저장을 권고</font>
	- <font color="#00b050">sudo apt-key add - : apt-key deprecated</font>
- docker에서 제공하는 GPG key 추가 확인
```
sudo apt-key fingerprint
or
sudo apt-key fingerprint 0EBFCD88
```
![[Pasted image 20250222000947.png]]
- apt repository source에 docker repo 추가. (keyring 포함)
```
echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```

- docker repository 추가하여 update 수행 : `sudo apt update`
- docker에서 제공하는 docker-ce 버전 확인
```
sudo apt-cache policy docker-ce
```
![[Pasted image 20250222004745.png]]

- 최신 docker version 설치
```
sudo apt -y install docker-ce
```

- 우분투 계정 권한 변경
```
sudo usermod -aG docker skyle
sudo systemctl daemon-reload
sudo systemctl enable docker
sudo systemctl restart docker
```

- Docker version 확인 : `docker version`
- ### <span style="background:#d3f8b6">docker 에서 제공하는 shell script을 Docker engine 설치</span>
	- docker 에서 제공하는 shell script을 이용한 자동 설치
		- `curl -fsSL https://get.docker.com -o get-docker.sh`
	- shell script 내용 확인 후 변경 가능
		- `sudo vi get-docker.sh`
	- 실행 권한 부여
		- `chmod +x get-docker.sh`
	- 설치
		- `sudo sh get-docker.sh`
- docker engine 삭제
	- `dpkg -l | grep -i docker `
		- ![[Pasted image 20250222010135.png]]
	- 삭제
```
sudo apt-get purge -y docker.io 
sudo apt-get autoremove -y --purge docker.io 
sudo apt-get autoclean 
sudo apt purge docker-ce
```
	- Host에 image, directory, 볼륨, 또는 사용자 생성 구성 파일을 제거
```
sudo rm /etc/apparmor.d/docker 
sudo rm -rf /var/lib/docker 
sudo groupdel docker 
sudo apt-get purge docker-engine 
sudo apt-get autoremove --purge docker-engine
```
- docker engine 정보 확인
	- `docker info`
		- <font color="#00b050">dockerd 가 관리하는 영역 중 storage 드라이버 : overlay2</font>
		- <font color="#00b050">생성 (runc) - Default Runtime: runc => 커널 공유를 통해 컨테이너 만듬</font> 
			- <font color="#00b050">kernel 보안 : Juicer</font>
		- <font color="#00b050">실행 (dockerd) - Init Binary: docker-init</font>
		- <font color="#00b050"> 관리 : containerd version: bcc810d6b9066471b0b6fa75f557a15a1cbf31bb </font>
	

# Clip5 간단한 컨테이너 서비스 구현 실습

### Dcoker 실습
```
docker images
docker pull centos:7
docker pull ubuntu:16.04
docker images
docker run -it --name=sys-container-1 centos:7 echo 'welcome fastcampus!'
docker ps -a
docker run -it --name=sys-container-2 centos:7 bash
	cat /etc/os-release
	ifconfig
	ping 8.8.8.8
	exit
docker start sys-container-2
docker exec -it sys-container-2 bash
docker inspect sys-container-2 | grep -i ipaddress
```
- <font color="#00b050">image는 layer 구조</font>
- <font color="#00b050">`ctrl + p + q` : 빠져나오기</font>
- <font color="#00b050">`-i` : 대소문자 무관 옵션</font>
### Nginx image를 통해 구현 가능한 컨테이너
- Nginx의 널리 사용되는 기술은 Web Server
- Nginx는 Reverse proxy 구현 가능한
- Nginx는 API 트래픽 처리가 가능한 고급 http 기능 보유, API Gateway 구현 가능
```
docker pull nginx:1.25.0-alpine
docker image history nginx:1.25.0-alpine
docker run -d -p 8001:80 --name=my-webserver1 nginx:1.25.0-alpine
docker ps | grep my-webserver1
docker port my-webserver1
curl localhost:8001
mkdir ch02 && cd $_
vi index.html
docker cp index.html my-webserver1:/usr/share/nginx/html/index.html
vi index-image.html
docker cp index-image.html my-webserver1:/usr/share/nginx/html/index.html
docker cp docker_logo.png my-webserver1:/usr/share/nginx/html/docker_logo.png
```
- <font color="#00b050">docker image를 다운로드 받은 후, 확인사항</font>
	- `docker images history nginx:1.25.0-alpine`
	- EXPOSE등을 확인할 수 있다.
- <font color="#00b050">port 확인 명령어</font>
	- `docker port my-webserver1`
	- `sudo netstat -nlp | grep 8001`
### 앞서 수행한 실습의 웹 소스(index.html & docker_logo.png)를 보유한 이미지를 만들고 싶다면?
```
vi Dockerfile
	FROM nginx:1.25.0-alpine 
	COPY index-image.html /usr/share/nginx/html/index.html 
	COPY docker_logo.png /usr/share/nginx/html/docker_logo.png 
	EXPOSE 80 
	CMD ["nginx", "-g", "daemon off;"]
docker build -t myweb:v1.0 .
docker images
docker run -d -p 8002:80 --name=my-webserver2 myweb:v1.0
curl localhost:8002
```
## 앞선 실습의 자료를 공유를 통해 다른 개발자에게 제공 한다면?
- Open share 방식의 "github"을 통해 공유
```
git clone https://github.com/hylee-kevin/fastcampus.git
cd fastcampus/ch02/
mv index_html_sample2.txt index-image.html
docker build -t myweb:v1.1 .
docker images
docker run -d -p 8003:80 --name=my-webserver3 myweb:v1.1
```
## 새로운 base image를 사용하는 경우에는 <span style="background:#d3f8b6">hub.docker.com</span>에서 해당 이미지를 찾아 설명을 읽고 사용하는 것을 권장한다.
- <font color="#00b050">alpine, slim 문구가 경량화 이미지이다.</font>
- <font color="#00b050">설명에서 기본 Setting 등의 설명들이 있다.</font>
```
docker pull mysql:5.7-debian
docker images
docker run -it -e MYSQL_ROOT_PASSWORD=skyle123 mysql:5.7-debian /bin/bash
	/etc/init.d/mysql start
	mysql -uroot -p
docker run -it -e MYSQL_ROOT_PASSWORD=skyle123 mysql:5.7-debian /bin/bash
docker run --name mariadb -e MYSQL_ROOT_PASSWORD=mkevin -d  -e MARIADB_DATABASE=item -p 3306:3306 mariadb:10.2
docker exec -it mariadb /bin/bash
	service mysql start
	mysql –uroot –p
		show databases;
		use item;
		CREATE TABLE Projects (id int(11) NOT NULL, name varchar(255) DEFAULT NULL, code varchar(255) DEFAULT NULL, PRIMARY KEY (id));
		show tables;
		insert into Projects (id, name, code) values (1,'DevOps','DO180');
		select * from Projects;
```

# Clip6 docker GUI 관리 도구 Portainer 만들기
### 웹 GUI 기반의 docker 컨테이너 관리 도구, portainer
- Portainer CE는 Docker, Swarm, Kubernetes 및 AC| 환경을 관리하는 데 사용할 수
있는 컨테이너화된 애플리케이션을 위한 경량 서비스 제공 플랫폼 이다
- 배포와 사용이 간단하게 설계되었고, 이 애플리케이션을 통해 'Smart' GUI 및
광범위한 API를 통해 docker에서 사용되는 대부분의 리소스(컨테이너, 이미지, 볼륨,
네트워크등)를 관리할 수 있다.
- https://hub.docker.com/r/portainer/portainer-ce
### Portainer 컨테이너 생성
```
docker pull portainer/portainer-ce
docker volume create portainer_data
docker run -d -p 9000:9000 -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data --restart=always portainer/portainer-ce
docker ps | grep portainer
# 접속은 서버IP:9000으로 크롬으로 접속한다.
```
- password : skyle12345678
- /var/run/docker.socket을 공유해서 컨테이너 정보등을 가져올 수 있다.
  
  ### Portainer APP Template으로 특정 컨테이너 배포하기
- Portainer는 App Templates를 기본적으로 제공
- 브라우저 콘솔 환경에서 이미지를 선택하고 명령어 없이 콘솔 환경에서 컨테이너 배포 가능.
- 간단한 웹 서버를 nginximage를 사용해 portainer를 통해 배포하는 실습이다
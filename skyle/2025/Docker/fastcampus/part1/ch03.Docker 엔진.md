ch03.Docker 엔진
Created at : 2025-02-23 21:18

# Clip1 최신 Docker 엔진을 사용해야 되는 이유?
### 최신 버전의 docker 엔진을 무조건 업데이트 해야 하나? 
- Docker 버전이 20.x버전에서의 정체를 뚫고 23.x를 빠르게 지나서 현재(영상을 찍는) 시점에는 24.x버전까지 빠르게 update된 상태이다. 
- 모든 software의 new version은 언제나 새로운 기능과 버그수정 및 보안 패치 등을 포함하여 만들어 진다. 
- Docker document에서 밝히는 최신성은 다음과 같은 장점을 갖는다. 
	1. ) <span style="background:#d3f8b6"><span style="background:#fff88f">기존 기능의 개선 및 new feature </span></span>
		docker는 플롯폼의 기능과 유용성을 개선하는 새로운 기능 및 개선 사항이 포함된 업데이트를 정기적으로 릴리스 하여 새로운 docker 기능을 도입하여 <span style="background:#d3f8b6">모든 작업의 workflow를 단순화할 수 있다. </span>
	2) <span style="background:#d3f8b6"><span style="background:#fff88f">버그수정</span> </span>
		docker에도 다른 소프트웨어 처럼 버그또는 예기치 못한 버그가 발생할 수 있다. 발견된 버그를 해결하여 안정성 및 성능을 개선하는 수정사항을 제공하기 때문에 docker를 최신 상태로 유지하면 보다 <span style="background:#d3f8b6">원활한 docker 작업을 보장받을 수 있다. </span>
	3) 보안 패치 
		널리 사용되고 있는 컨테이너화 플랫폼인 docker는 보안 취약성에 대해 지속적으로 inspect 되어, <span style="background:#d3f8b6">최신 버전의 docker을 사용하면 최신 보안 패치를 사용하여 잠재적 악용 위험을 최소화하고 컨테이너화 된 애플리케이션의 전반적인 보안 태세를 개선할 수 있다</span> 
	4) <span style="background:#d3f8b6"><span style="background:#fff88f">성능 개선</span> </span>
		docker 업데이트에 종종 성능 최적화가 포함되어 있기 때문에 작업을 더 빠르고 효율적으로 만든다. 이러한 개선 사항은 컨테이너 시간 단축, 네트워킹 및|1/0 성능 향상, 전반적인 리소스 활용도 향상으로 이어질 수 있다. 따라서, 최신성을 갖는 docker는 <span style="background:#d3f8b6">컨테이 너화 된 애플리케이션을 최적화할 수 있다. </span>
	5) <span style="background:#d3f8b6"><span style="background:#fff88f">최신 기술과의 호환성</span></span>
		기술 환경은 지속적으로 발전하고 있으며 새로운 도구와 프레임워크가 새롭게 생겨나고 있다. 최신 버전 의 Docker를 사용하여 최신기술과의 호환성이 보장되어 <span style="background:#d3f8b6">컨테이너 환경에서 새로운 최신 tool들을 활용할 수있다. </span>
	6) <span style="background:#d3f8b6"><span style="background:#fff88f">커뮤니티 및 생태계 지원</span> </span>
		docker가 발전은 주변 생태계의 발전에 영향을 준다. 인기있는 도구 및 라이브러리 들은 docker 기능 및 버전을 지원하도록 업데이트되고, 최신버전의 <span style="background:#d3f8b6">docker를 사용하여 docker 기반 플러그인 및 통합을 활용 해 컨테이너화 된 application을 buld 및 관리하기 위한 옵션을 사용 가능하다 </span>
	7) <span style="background:#d3f8b6"><span style="background:#fff88f">유지 관리 및 오랜 기간 동안의 지원(Long Term Support) </span></span>
		docker는 일부 release를 장기지원 (LTS) 버전으로 지정하는 관리체계를 따른다. LTS 버전은 버그 수정 및 보안 패치를 포함하여 확장된 유지 관리 및 지원을 받아 중요한 프로덕션 환경에 적합하기 때문에 최신 Docker를 사용하면 <span style="background:#d3f8b6">장기적인 요구 사항에 대해 안정적이고 잘 지원되는 docker 환경을 보장받을 수 있다. </span>
	8) (참고] 
		- https://docs.docker.com/engine/release-notes/23.0/
		- https://docs.docker.com/engine/release-notes/24.0/ 

# Clip2 운용 중인 Docker 엔진 업그레이드

### 실습 내용 소개 
- [시나리오] 현재 F사는 ubunt18.04 운영체제에 docker 19.x 버전을 사용 중이다. 새로운 기능의 호환성을 맞추고 성능 향상을 위해 최신 버전 업데이트를 결정했다. 작업 절차는 다음과 같다. 
	1) 기존에 실행 중인 컨테이너들을 stop 한다.  
	2) 현재 사용 중인 19.x버전의 docker 엔진을 삭제한다 
	3) 최신 버전의 docker 엔진을 설치한다. 
	4) 기존 버전에서 운영 중이 였던 컨테이너 기동(start)! 
	5) lf,error 발생 시 원인 파악, 문제 해결 등 중지되었던 컨테이너 start 
	6) 필요에 따라 Ubuntu Linux도 4804 -922:04로upgrade 수행 (실습에서는 제외) 
- OS 및 docker 버전 확인
```
uname -ar
cat /etc/os-release
docker version
```
- sample conatainer 실행
```
docker run -d -p 9001:80 --name=nginx-web nginx:1.19
docker run -d -p 9002:80 --name=httpd-web httpd:2.4
docker ps
```
- docker 엔진 update 전에 해당 컨테이너를 stop 하거나, docker 삭제시 자동 강제 Stop 됨
- 현재 사용중인 docker-ce 19 버전 삭제
```
sudo apt update
sudo apt -y remove docker-ce
```
- 최신 버전의 docker 설치를 위한 준비
```
sudo apt-get install -y \
apt-transport-https \
ca-certificates \
curl \
gnupg-agent \
software-properties-common
```
- gpg key download
```
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
```
- docker repository 등록
```
echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```
- 최신 버전 docker 설치 및 확인
```
sudo apt -y install docker-ce docker-ce-cli containerd.io
docker --version
docker version
docker ps -a
```
- 이전 버전에서 실행 중이던 컨테이너를 실행 시킨다.
```
docker start nginx-web
docker start httpd-web
docker ps -a
curl localhost:9001
curl localhost:9002
```
- [참고] 만약 이전 버전에서 실행 중이던 컨테이너 start 시 간혹 아래와 같은 오류가 발생한다.
```
docker start nginx-web
# error
docker:Error response from daemon:cgroups:cgroup mountpoint does not exist: unkwnoun.
```
- [Solution] 에러 메시지 내용처럼 cgroup mountpoint가 없는 문제다. 따라서, cgroup path에 디렉토리를 만들어주고 mount 해준다. 
```
sudo mkdir /sys/fs/cgroup/systemd
sudo mount -t cgroup -o none,name=systemd cgroup /sys/fs/cgroup/systemd
```
